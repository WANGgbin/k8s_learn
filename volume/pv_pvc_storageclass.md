# pv

## 要解决的问题

容器化应用我们经常会有这样一个需求：当应用 pod 退出后，我们希望 pod 写到存储的信息还能保存下来，即持久化存储(与容器无关、与容器所在的节点无关)，
这样后续重新创建应用 pod 的时候，如果能够将 pod 与之前写入的持久化 volume 绑定，这样信息就不会丢失，pod 就可以继续使用之前持久化的信息。

而在 k8s 中，一般情况下，当 pod 退出时，pod 在磁盘上写入的信息后续也会被删除(garbage collector)，这显然无法满足我们的需求。那怎么办呢？

pv(persistent volume) 这个 api 对象就是为了解决持久化存储的问题。

## 怎么解决的

在 pod 中，我们可以声明一个 pv 对象，该对象定义你想要多大、访问权限是什么、从哪个存储服务分配存储(S3、local stroage(k8s集群内部节点挂载磁盘实现数据持久化)),
这样当 pod 对象创建出来的时候，k8s 内部 volumeController 就会调用外部存储服务分配磁盘信息，创建 volume。

这个 volume 之后怎么被 k8s 使用呢？主要包括两步：

- attach
    
    对于某个节点而言，要能识别从外部分配的存储，第一步就是进行绑定操作，这个绑定操作就是所谓的 attach. 类似在电脑上插入一个 u 盘。
    attach 之后，这个 volume 就类似于节点本身一个块设备，会出现一个 /dev/xxx 文件。后续就可以进行 mount 进行使用了。
- mount

    识别之后，就可以将这个 volume 挂载到宿主机的某个目录，供应用 pod 来使用了。

# pvc

## 要解决的问题

pv 的问题是与底层的存储服务高耦合，对开发人员而言有些复杂，而且暴露了底层存储分配的细节，有安全风险。

站在开发人员的角度考虑，只关系要多大的存储，存储的读写权限就够了，无须存储如何分配的细节。分配细节可以交给专业的运维人员来完成。

而 pvc(persistent volume claim) 给开发人员提供了一种新的、更简单的对持久化存储的需求声明。

## 怎么解决的

开发人员声明 pvc 对象，运维人员声明 pv 对象。当 pvc 对象创建出来的时候，控制器就会将 pvc 与 pv 绑定，这样 pvc 就可以使用。
之后开发人员创建 pod，并在 pod 中声明 pvc，后续的流程与 pv 流程类似。

# storage class

## 要解决的问题

有了 pvc 对于开发人员是简单了，但是 pv 的创建还是手动创建的。如果 有成千上万的 pvc，还需要手动创建对应的 pv 对象，pvc 才能绑定进而可以被使用。

手动创建 pv 这太低效了。有没有自动化创建 pv 对象的方法呢？

这就是 storage class 解决的问题。

## 怎么解决的

我们需要声明一个 storage class api 对象，storage class 主要包括创建 pv 需要用到的存储插件通过 provisioner 字段指定。

在 pvc 的 storage class 字段中只需要指定某个 storage class 对象的 name 即可。当 pvc 对象创建出来后，控制器就会通过 pvc.storage_class
找到对应的 storage class 对象，然后调用该对象指定的方式自动为 pvc 创建 pv，这个过程称为：dynamic provision(供应的意思)。